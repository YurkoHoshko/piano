# Build Progress Log
Started: 2026-01-18
Feature: Piano - Multi-Agent Chat System
Parent Task: 1

## Codebase Patterns
- Ash domains declared in config/config.exs under `:ash_domains` key
- Use `ash.codegen <name>` to generate migrations, then `ash.migrate` to apply
- AshSqlite.Repo requires otp_app: :piano
- Spark.Formatter plugin in .formatter.exs for Ash DSL formatting

---

## 2026-01-18 - US-001: Project Setup and Ash Domain Structure
Thread: https://ampcode.com/threads/T-019bd3e0-a8ce-7299-85c2-017af696cf1f
Task ID: 2
- Created Phoenix LiveView project structure from scratch
- Added Ash Framework with SQLite (ash ~> 3.0, ash_sqlite ~> 0.2, ash_phoenix ~> 2.0)
- Created Piano.Chat domain with Thread and Message resources
- Created Piano.Agents domain with Agent resource
- Generated and applied initial migrations
- All acceptance criteria met: mix compile passes, migrations applied

**Files created:**
- lib/piano/application.ex - Application supervisor
- lib/piano/repo.ex - AshSqlite repo
- lib/piano/chat.ex - Chat domain
- lib/piano/chat/thread.ex - Thread resource
- lib/piano/chat/message.ex - Message resource  
- lib/piano/agents.ex - Agents domain
- lib/piano/agents/agent.ex - Agent resource
- lib/piano_web.ex - Phoenix web module
- lib/piano_web/endpoint.ex, router.ex, telemetry.ex
- lib/piano_web/controllers/*, components/*
- config/*.exs - Configuration files
- assets/* - JS/CSS/Tailwind setup

**Learnings for future iterations:**
- When using pipe with custom functions that take JS struct, first param should be js, second the selector
- ash.codegen generates migrations in _build, ash.migrate applies them
- Test database lock errors are transient, tests still pass

---

## 2026-01-18 - US-002: Thread Resource
Thread: https://ampcode.com/threads/T-019bd3e7-bded-768c-98f2-a30d24813785
Task ID: 3
- Added belongs_to :primary_agent relationship (optional) to Thread
- Added :list action with descending inserted_at sort
- Updated :create action to accept primary_agent_id argument
- Generated and applied migration for primary_agent_id column

**Files changed:**
- lib/piano/chat/thread.ex - Added relationship and actions
- priv/repo/migrations/*_add_primary_agent_to_threads.exs - New migration

**Learnings for future iterations:**
- belongs_to relationships automatically add _id foreign key column
- manage_relationship with type: :append works for optional belongs_to associations

---

## 2026-01-18 - US-003: Message Resource  
Thread: https://ampcode.com/threads/T-019bd3e9-3e73-703e-9bdc-6221f5e26cf9
Task ID: 4
- Verified Message resource already fully implemented in US-001
- Has all required attributes: id, content, role, source, inserted_at
- Has belongs_to :thread (required) and belongs_to :agent (optional)
- Has actions: :read, :create, :list_by_thread
- mix compile passes

**Status:** Already complete from initial setup, marked as done.

---

## 2026-01-18 - US-004: Agent Resource
Thread: https://ampcode.com/threads/T-019bd3e9-3e73-703e-9bdc-6221f5e26cf9
Task ID: 5
- Added :list action with ascending inserted_at sort
- Created priv/repo/seeds.exs with default agent seed
- Default agent: "Assistant" with model "qwen3:32b"
- mix compile passes, seed runs successfully

**Files changed:**
- lib/piano/agents/agent.ex - Added :list action
- priv/repo/seeds.exs - New seed file for default agent

---

## 2026-01-18 - US-005: Tool Registry
Thread: https://ampcode.com/threads/T-019bd3eb-3c67-71cc-b469-ef8c83782a64
Task ID: 6
- Created Piano.Agents.ToolRegistry module
- Defined 4 tools: read_file, create_file, edit_file, bash
- Each tool has: name, description, parameters schema (JSON Schema format), callback function
- Implemented get_tools/1 to return tool definitions for enabled tool names
- Implemented list_available/0 to return all tool names
- All tool callbacks handle errors gracefully

**Files created:**
- lib/piano/agents/tool_registry.ex - Tool registry with 4 tools and callbacks

**Learnings for future iterations:**
- Tool parameters use JSON Schema format for OpenAI-compatible tool definitions
- Callbacks return {:ok, result} | {:error, reason} tuples for consistent handling
- bash tool uses System.cmd with sh -c for portable command execution

---

## 2026-01-18 - US-006: Skill Loader
Thread: https://ampcode.com/threads/T-019bd3ec-7e3b-750f-b21f-b001baae68b5
Task ID: 7
- Created Piano.Agents.SkillRegistry module
- Scans `.agents/skills/` directory for `.md` files
- Each skill file becomes a prompt snippet keyed by filename (without .md extension)
- Implemented list_available/0 to return all skill names
- Implemented get_prompts/1 to concatenate prompt text for enabled skills
- Implemented load_skill/1 helper to read individual skill files
- Created `.agents/skills/` directory
- mix compile passes

**Files created:**
- lib/piano/agents/skill_registry.ex - Skill registry with directory scanning
- .agents/skills/ - Directory for skill markdown files

**Learnings for future iterations:**
- File.ls returns {:error, _} for non-existent directories - handle gracefully with empty list
- Skills are loaded dynamically at runtime, not compiled in - allows adding skills without restart

---

## 2026-01-18 - US-007: GenStage Message Producer
Thread: https://ampcode.com/threads/T-019bd3ed-8415-71c0-af1f-b9c8e99cdba9
Task ID: 8
- Added gen_stage ~> 1.2 dependency to mix.exs
- Created Piano.Pipeline.MessageProducer GenStage module
- Implemented enqueue/1 function to add message events via cast
- Uses :queue for internal event buffering
- Tracks pending demand and dispatches events when consumers request
- Added to application supervisor (before PianoWeb.Endpoint)
- mix compile passes

**Files created:**
- lib/piano/pipeline/message_producer.ex - GenStage producer with queue buffering

**Files changed:**
- mix.exs - Added gen_stage dependency
- lib/piano/application.ex - Added MessageProducer to supervision tree

**Learnings for future iterations:**
- GenStage producer uses {:producer, state} tuple in init
- Use :queue module for efficient FIFO event buffering
- Pending demand must be tracked when queue is empty to dispatch later
- handle_cast for async enqueue, handle_demand for consumer requests

---

## 2026-01-18 - US-008: GenStage Agent Consumer
Thread: https://ampcode.com/threads/T-019bd3ee-fb0b-7211-9148-94b116dd7d76
Task ID: 9
- Created Piano.Pipeline.AgentConsumer GenStage consumer module
- Subscribes to MessageProducer with max_demand: 1
- Loads agent config via Ash.get(Agent, agent_id)
- Loads thread message history via Ash.read with :list_by_thread action
- Builds system prompt from agent.system_prompt + enabled skills
- Calls LLM via Piano.LLM.complete/3 with llama-swap OpenAI-compatible API
- Handles tool calls: executes tools from ToolRegistry and continues conversation
- Creates agent Message in database with response
- Broadcasts lifecycle events: :processing_started, :response_ready, :processing_error
- Added to application supervisor after MessageProducer
- Created Piano.LLM module for llama-swap HTTP calls using Req
- Created Piano.Events module for PubSub helpers
- Added LLM config to config/config.exs (base_url, default_model)
- mix compile --warnings-as-errors passes

**Files created:**
- lib/piano/pipeline/agent_consumer.ex - GenStage consumer with LLM integration
- lib/piano/llm.ex - LLM client for llama-swap OpenAI-compatible API
- lib/piano/events.ex - PubSub broadcast/subscribe helpers

**Files changed:**
- mix.exs - Added req ~> 0.5 dependency for HTTP calls
- config/config.exs - Added :llm config with base_url and default_model
- lib/piano/application.ex - Added AgentConsumer to supervision tree

**Learnings for future iterations:**
- GenStage consumer uses subscribe_to option in init to connect to producer
- max_demand: 1 processes one message at a time (safe for LLM calls)
- Tool call loop: execute tools, append results as tool role messages, call LLM again
- Req.post with json: option auto-encodes body and sets Content-Type header

---
