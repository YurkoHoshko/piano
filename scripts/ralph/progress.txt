# Build Progress Log
Started: 2026-01-20
Feature: Telegram UX Improvements
Parent Task: 52

## Codebase Patterns
- Ash domains declared in config/config.exs under `:ash_domains` key
- Use `ash.codegen <name>` to generate migrations, then `ash.migrate` to apply
- Ash.read with action arguments: `Ash.Query.for_read(Resource, :action, %{arg: value}) |> Ash.read()`
- Ash.create with action arguments: `Ash.Changeset.for_create(Resource, :action, %{attrs}) |> Ash.create!()`
- GenStage producer uses {:producer, state} tuple in init
- Use :queue module for efficient FIFO event buffering
- Telegram API wrapper: Piano.Telegram.API with behaviour for mocking
- ExGram commands registered with command("name") macro, handler matches {:command, :name, msg}
- Pattern: send placeholder → store message_id → edit on response (send_or_edit helper)
- ETS :piano_pending_requests with :public allows any process to signal cancellation
- Message splitting at natural boundaries for Telegram's 4096 byte limit

---

## Task 53: US-001 Reply to user message
**Status:** Complete
**Date:** 2026-01-20

**Changes:**
- Updated `handle({:text, text, msg}, _context)` to capture `msg.message_id`
- Added `reply_to_message_id` option to placeholder `API.send_message` call
- Updated `send_or_edit/5` to accept and pass `user_message_id` for fallback messages
- Updated `send_long_response/6` to accept `user_message_id`
- Updated `wait_for_response/5` and `/7` to thread `user_message_id` through all calls
- Updated ETS entry to store `user_message_id` for `/cancel` command support
- Added 2 new tests: "placeholder message replies to user's original message" and "fallback send_message includes reply_to_message_id"

**Test coverage note:** When adding new functionality, ensure test coverage for:
- Happy path (placeholder includes reply_to_message_id)
- Fallback path (when edit fails, new message includes reply_to_message_id)
- Edge cases (nil message_id handled gracefully via Map.get)

---

## Task 54: US-005 Skill discovery and loading
**Status:** Complete
**Date:** 2026-01-20

**Changes:**
- Rewrote `SkillRegistry` to scan `.piano/skills/*/SKILL.md` instead of `.agents/skills/*.md`
- Added YAML frontmatter parsing via `YamlElixir` to extract name and description
- Created ETS table `:piano_skills` for fast in-memory skill storage
- Added `init/0` function called from `Application.start/2`
- Added `format_for_system_prompt/0` to provide available skills list to LLM
- Updated `SystemPrompt.build/2` to include available skills in the prompt
- Application logs discovered skills on startup
- Added test fixtures in `test/fixtures/.piano/skills/`
- Added `SkillRegistryTest` with 8 tests covering all functionality

**Key functions:**
- `SkillRegistry.init/0` - initializes ETS and discovers skills
- `SkillRegistry.list_available/0` - returns list of skill metadata
- `SkillRegistry.load_skill/1` - loads full SKILL.md content by name
- `SkillRegistry.format_for_system_prompt/0` - formats available skills for LLM

---
